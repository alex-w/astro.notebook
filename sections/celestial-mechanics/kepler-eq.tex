\subsection{Уравнение Кеплера}

\begin{wrapfigure}[11]{r}{0.48\tw}
    \centering
    \vspace{-0.3pc}
    \tikzsetnextfilename{kepler-eq}
    \begin{tikzpicture}
        \footnotesize

        \def\a{4}
        \def\e{0.63}
        \def\E{43}
        \def\M{\E - \e * sin(\E) * 180 / pi}
        \def\ellipseAngle{90}
        \def\circleAngle{55}

        \def\b{sqrt(1 - \e * \e)}

        \tkzDefPoint(0,0){C}
        \tkzDefShiftPoint[C](\a,0){P}
        \tkzDefPointBy[homothety=center C ratio \e](P) \tkzGetPoint{F}
        \tkzDefPointBy[rotation=center C angle \E](P) \tkzGetPoint{A}
        \tkzDefPointBy[rotation=center C angle \M](P) \tkzGetPoint{D}
        \tkzDefPointBy[projection = onto C--P](A) \tkzGetPoint{H}
        \tkzDefPointBy[homothety=center H ratio \b](A) \tkzGetPoint{B}
        
        \tkzDefPointBy[homothety=center C ratio \b](P) \tkzGetPoint{x}
        \tkzDefPointBy[rotation=center C angle \ellipseAngle](x) \tkzGetPoint{o}
        
        \tkzDefPointBy[rotation=center C angle \circleAngle](P) \tkzGetPoint{c}
        
        
        \begin{scope}[yscale=\b]
             \draw[thick] (P) arc (0:\ellipseAngle:\a);
        \end{scope}

        \draw[semithick] (P) arc (0:\circleAngle:\a);

        \tkzDrawSegments(C,A A,H C,D)
        \tkzDrawSegments[semithick](C,P F,B)
        \tkzDrawSegments[dashed](F,A)

        \tkzDrawPoints(C, P, F, A, D, H, B)

        \tkzLabelPoints[below](C, P, F, H)
        \tkzLabelPoints[above right=-1pt](A, D)
        \tkzLabelPoints[below](o, c)
        \tkzLabelPoints[above right=-2pt](B)

        \tkzMarkAngle[arc=l, size=0.2](H,F,B)
        \tkzLabelAngle[pos=0.35](H,F,B){\footnotesize$\nu$}

        \tkzMarkAngle[arc=ll, size=0.5](P,C,A)
        \tkzLabelAngle[pos=0.75, fill=white, inner sep=0.5](P,C,A){\footnotesize$E$}

        \tkzMarkAngle[arc=lll, size=1.2](P,C,D)
        \tkzLabelAngle[pos=1.47](P,C,D){\footnotesize$M$}
    \end{tikzpicture}
    \caption{К выводу уравнения Кеплера}
    \label{pic:kepler-eq}
\end{wrapfigure}
Рассмотрим эллиптическую орбиту $o$ с центром в точке $C$, центральным телом в фокусе $F$ и большой полуосью $a$. Обозначим за $P$ перицентр данной орбиты, тогда $|CP| = a$. Рассмотрим также окружность $c$, с центром в точке в точке $C$ и радиусом $a$, очевидно, эта окружность будет касаться эллипса внешним образом в точке~$P$. Выберем на эллипсе произвольную точку $B$. Проведем через нее прямую, параллельную малой оси эллипса. Точку пересечения полученной прямой с окружностью $c$ назовем $A$. Угол $E = \angle ACP$ называется \term[эксцентрическая аномалия]{эксцентрической аномалией} точки $B$.


Получим связь средней аномалии $M$ с эксцентрической~--- $E$~\cite{orbital-motion-roy}. Прежде всего напомним, что эллипс является результатом действия аффинного преобразования сжатия (вдоль малой оси) на окружность с радиусом~$a$. И, наоборот, окружность под действием растяжения переходит в эллипс. В наших обозначениях будем считать, что окружность $o$ под действием сжатия $\xi$ с коэффициентом $a/b$ переходит в эллипс $o$.

\begin{figure}[h!]

    \begin{subcaptionblock}{0.47\tw}
        \tikzsetnextfilename{kepler-eq-BFP-AFP}
        \begin{tikzpicture}
            \footnotesize

            \def\a{4}
            \def\e{0.63}
            \def\E{43}
            \def\M{\E - \e * sin(\E) * 180 / pi}
            \def\ellipseAngle{90}
            \def\circleAngle{55}

            \def\b{sqrt(1 - \e * \e)}

            \tkzDefPoint(0,0){C}
            \tkzDefShiftPoint[C](\a,0){P}
            \tkzDefPointBy[homothety=center C ratio \e](P) \tkzGetPoint{F}
            \tkzDefPointBy[rotation=center C angle \E](P) \tkzGetPoint{A}
            \tkzDefPointBy[rotation=center C angle \M](P) \tkzGetPoint{D}
            \tkzDefPointBy[projection = onto C--P](A) \tkzGetPoint{H}
            \tkzDefPointBy[homothety=center H ratio \b](A) \tkzGetPoint{B}

            \tkzDefPointBy[homothety=center C ratio \b](P) \tkzGetPoint{x}
            \tkzDefPointBy[rotation=center C angle \ellipseAngle](x) \tkzGetPoint{o}

            \tkzDefPointBy[rotation=center C angle \circleAngle](P) \tkzGetPoint{c}

            \draw[line width=2pt, lightgray, line join = round] (P) arc(0:\E:\a) -- (F) -- cycle;

            \begin{scope}[yscale=\b]
                \draw[line width=2pt, lightgray, line join = round] (P) arc(0:\E:\a) -- (F) -- cycle;
                \draw[thick] (P) arc (0:\ellipseAngle:\a);
            \end{scope}

            \draw[semithick] (P) arc (0:\circleAngle:\a);

            \tkzDrawSegments(C,A A,H C,D)
            \tkzDrawSegments[semithick](C,P F,B)
            \tkzDrawSegments[dashed](F,A)

            \tkzDrawPoints(C, P, F, A, D, H, B)

            \tkzLabelPoints[below](C, P, F, H)
            \tkzLabelPoints[above right=-1pt](A, D)
            \tkzLabelPoints[below](o, c)
            \tkzLabelPoints[above right=-2pt](B)

            \tkzMarkAngle[arc=l, size=0.2](H,F,B)
            \tkzLabelAngle[pos=0.35](H,F,B){\footnotesize$\nu$}

            \tkzMarkAngle[arc=ll, size=0.5](P,C,A)
            \tkzLabelAngle[pos=0.75, fill=white, inner sep=0.5](P,C,A){\footnotesize$E$}

            \tkzMarkAngle[arc=lll, size=1.2](P,C,D)
            \tkzLabelAngle[pos=1.47](P,C,D){\footnotesize$M$}
        \end{tikzpicture}
        \caption{Секторы $\sector BFP$ и $\sector AFP$}
        \label{pic:kepler-eq-BFP-AFP}
    \end{subcaptionblock}
    \hfill
    \begin{subcaptionblock}{0.47\tw}
        \tikzsetnextfilename{kepler-eq-BFP-DCP}
        \begin{tikzpicture}
            \footnotesize

            \def\a{4}
            \def\e{0.63}
            \def\E{43}
            \def\M{\E - \e * sin(\E) * 180 / pi}
            \def\ellipseAngle{90}
            \def\circleAngle{55}

            \def\b{sqrt(1 - \e * \e)}

            \tkzDefPoint(0,0){C}
            \tkzDefShiftPoint[C](\a,0){P}
            \tkzDefPointBy[homothety=center C ratio \e](P) \tkzGetPoint{F}
            \tkzDefPointBy[rotation=center C angle \E](P) \tkzGetPoint{A}
            \tkzDefPointBy[rotation=center C angle \M](P) \tkzGetPoint{D}
            \tkzDefPointBy[projection = onto C--P](A) \tkzGetPoint{H}
            \tkzDefPointBy[homothety=center H ratio \b](A) \tkzGetPoint{B}

            \tkzDefPointBy[homothety=center C ratio \b](P) \tkzGetPoint{x}
            \tkzDefPointBy[rotation=center C angle \ellipseAngle](x) \tkzGetPoint{o}

            \tkzDefPointBy[rotation=center C angle \circleAngle](P) \tkzGetPoint{c}

            \draw[line width=2pt, lightgray, line join = round] (P) arc(0:\M:\a) -- (C) -- cycle;

            \begin{scope}[yscale=\b]
                \draw[line width=2pt, lightgray, line join = round] (P) arc(0:\E:\a) -- (F) -- cycle;
                \draw[thick] (P) arc (0:\ellipseAngle:\a);
            \end{scope}

            \draw[semithick] (P) arc (0:\circleAngle:\a);

            \tkzDrawSegments(C,A A,H C,D)
            \tkzDrawSegments[semithick](C,P F,B)
            \tkzDrawSegments[dashed](F,A)

            \tkzDrawPoints(C, P, F, A, D, H, B)

            \tkzLabelPoints[below](C, P, F, H)
            \tkzLabelPoints[above right=-1pt](A, D)
            \tkzLabelPoints[below](o, c)
            \tkzLabelPoints[above right=-2pt](B)

            \tkzMarkAngle[arc=l, size=0.2](H,F,B)
            \tkzLabelAngle[pos=0.35](H,F,B){\footnotesize$\nu$}

            \tkzMarkAngle[arc=ll, size=0.5](P,C,A)
            \tkzLabelAngle[pos=0.75, fill=white, inner sep=0.9](P,C,A){\footnotesize$E$}

            \tkzMarkAngle[arc=lll, size=1.2](P,C,D)
            \tkzLabelAngle[pos=1.47](P,C,D){\footnotesize$M$}
        \end{tikzpicture}
        \caption{Секторы $\sector DCP$ и $\sector BFP$}
        \label{pic:kepler-eq-BFP-DCP}
    \end{subcaptionblock}
    \caption{}
\end{figure}

Найдем связь площадей секторов $\sector AFP$ и $\sector BFP$. Нетрудно заметить, что первый переходит во второй под действием $\xi$. Из свойств аффинного преобразования получаем:
\begin{equation*}
    \frac{\area \sector BFP}{\area \sector AFP} = \frac{b}{a}.
\end{equation*}


Как известно, площадь эллипса $S = \pi ab$, а круга с той же большой полуосью~---  $S' = \pi a^2$. По второму закону Кеплера радиус-вектор тела $\overrightarrow{FB}$ за равные промежутки времени заметает равные площади, то есть скорость заметания постоянна и равна $\sigma = \pi a b / T$. A из определения средней аномалии следует, что угловая скорость вектора $\overrightarrow{CD}$ также постоянна и равна $\sigma' = \pi a^2 / T$. Отсюда можно сделать вывод о соотношении между площадями секторов $\sector BFP$ и $ \sector DCP$:
\begin{equation*}
    \frac{\area \sector BFP}{\area \sector DCP} = \frac{b}{a}.
\end{equation*}
Следовательно, $\area \sector DCP = \area \sector AFP$.

Как для площади центрального сектора, для $\area \sector DCP$ верно
\begin{equation*}
    \area \sector DCP = \frac{a^2}{2} M,
\end{equation*}
здесь угол $M$, конечно, в радианной мере. Аналогично для $\area \sector ACP$:
\begin{equation*}
    \area \sector ACP = \frac{a^2}{2} E.
\end{equation*}
С другой стороны $\sector ACP = \sector AFP + \triangle ACF$, а, значит,
\begin{equation}
    \area \sector ACP = \area\sector AFP + \area\triangle ACF.
    \label{eq:kepler-eq-acp}
\end{equation}
Найдем площадь треугольника $\triangle ACF$:
\begin{equation*}
    \area \triangle ACF = \frac{1}{2} |CF| \cdot |AC| \sin E = \frac{1}{2} a e \cdot a \sin E =  \frac{a^2 e\sin E}{2}
\end{equation*}
Тогда из равенства $\area \sector DCP = \area \sector AFP$ и \eqref{eq:kepler-eq-acp} получаем:
\begin{equation*}
    \frac{a^2}{2} E = \frac{a^2 e\sin E}{2} + \frac{a^2}{2} M.
\end{equation*}
Отсюда получаем так называемое \term{уравнение Кеплера}, оно связывает среднюю и эксцентрическую аномалии
\begin{equation}\label{eq:kepler-eq}
    M = E - e \sin E.
\end{equation}
Найдем теперь зависимость эксцентрической аномалии $E$ от истинной, чтобы связать все три аномалии. Вспомним, что точка $B$ принадлежит эллипсу $o$, следовательно, она удовлетворяет уравнению эллипса в декартовых координатах, значит
\begin{equation}
    \frac{|CH|^2}{a^2} + \frac{|BH|^2}{b^2} = 1.
    \label{eq:kepler-eq-dec-eq}
\end{equation}
Далее, $|CH| = |AC| \cos E = a \cos E$, как прилежащий к углу $\angle E$ катет в прямоугольном треугольнике $\triangle AHC$. Выразим теперь $|BH|$ из \eqref{eq:kepler-eq-dec-eq}:
\begin{equation*}
    |BH| = b\sqrt{1 - \frac{|CH|^2}{a^2}} = a \sqrt{1 - e^2} \sqrt{1 - \frac{a^2 \cos^2 E}{a^2}} = a \sqrt{1 - e^2} \sin E .
\end{equation*}
Найдем $|FH|$:
\begin{equation*}
    |FH| = |CH| - |CF| = a \cos E - a e = a (\cos E - e).
\end{equation*}
Запишем теорему Пифагора для прямоугольного треугольника $\triangle BHF$:
\begin{align*}
    |FB|^2 &= |FH|^2 + |BH|^2 = \\
    &= a^2 (\cos E - e)^2 + a^2 \left( 1 - e^2 \right) \sin^2 E = \\
    &= a^2 \left( \cos^2 E + e^2 - 2 e \cos E + \sin^2 E - e^2 \sin^2 E \right) = \\
    &= a^2 \Big( 1 - 2 e \cos E + e^2 \left( 1 - \sin^2 E \right) \Big) =  a^2 \left( 1 - e \cos E \right)^2
\end{align*}
Приравняем полученное выражение для $|FB|$ и выражение через уравнение эллипса в полярных координатах:
\begin{equation*}
    |FB| = r = \frac{a \left(1 - e^2 \right)}{ 1 + e \cos \nu},
\end{equation*}
\begin{equation}
    1 - e \cos E  = \frac{1 - e^2}{ 1 + e \cos \nu}.
    \label{eq:kepler-eq-E-nu-1}
\end{equation}

\newcommand{\sqTgHalf}[1]{#1'}

Приведем \eqref{eq:kepler-eq-E-nu-1} к более простому виду. Воспользуемся для этого формулой для косинуса двойного угла
\begin{equation*}
     \cos x = \frac{\raisebox{5pt}{$1 - \tg^2 \dfrac{x}{2}$}}{\raisebox{-5pt}{$1 + \tg^2 \dfrac{x}{2}$}},
\end{equation*}
подставим её в \eqref{eq:kepler-eq-E-nu-1}, приведем левую и правую части к общим знаменателям и введём обозначения $\sqTgHalf{E} \equiv \tg^2 (E/2)$ и $\sqTgHalf{\nu} \equiv \tg^2 (\nu/2)$:
\begin{gather*}
    \frac{1 + \sqTgHalf{E} - e + e \sqTgHalf{E}}{1 + \sqTgHalf{E}} = \frac{(1 - e^2) \left( 1 + \sqTgHalf{\nu} \right)}{1 + \sqTgHalf{\nu} + e - e \sqTgHalf{\nu}},\\
    \frac{(1 - e) + (1 + e) \sqTgHalf{E}}{1 + \sqTgHalf{E}} = \frac{(1-e)(1+e)\left( 1 + \sqTgHalf{\nu} \right)}{(1 + e) + (1 - e) \sqTgHalf{\nu} }.
\end{gather*}
Разделим обе части на $1 + e$, сократим правую на $1 - e$, также введём обозначение $\varepsilon = (1 - e) / (1 + e)$:
\begin{equation*}
    \frac{\varepsilon + \sqTgHalf{E}}{1 + \sqTgHalf{E}} = \frac{1 + \sqTgHalf{\nu}}{1 / \varepsilon + \sqTgHalf{\nu}}.
\end{equation*}
Перемножив члены пропорции и приведя подобные, получим
\begin{gather}
    \sqTgHalf{E} = \varepsilon \sqTgHalf{\nu},\nonumber\\
    \tg \frac{E}{2} = \sqrt{\frac{1 - e}{1 + e}} \tg \frac{\nu}{2}.
    \label{eq:kepler-eq-E-nu-2}
\end{gather}
Полученное равенство завершает систему уравнений для $\nu$, $E$ и $M$.
